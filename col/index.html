<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DR.XIAOMI - Servicio T√©cnico</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      width: 100%;
      max-width: 900px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    header {
      background: linear-gradient(135deg, #FF6B35 0%, #FF9800 100%);
      padding: 30px 20px;
      text-align: center;
      color: white;
    }

    header h1 {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 5px;
    }

    main {
      padding: 30px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .form-section {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
    }

    .form-section h3 {
      color: #FF6B35;
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 15px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }

    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      font-size: 14px;
    }

    /* Secci√≥n de Servicios Mejorada */
    .services-section {
      grid-column: span 2;
    }
    
    .services-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .services-list {
      border: 2px solid #e1e5e9;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
    }
    
    .service-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }
    
    .service-row input[type="text"] {
      flex-grow: 1;
    }
    
    .service-row input[type="number"] {
      width: 120px;
    }
    
    .remove-service-btn {
      background: #ff4757;
      color: white;
      border: none;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .add-service-btn {
      background: #FF6B35;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 5px;
      margin-bottom: 15px;
    }
    
    .total-section {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 10px;
      text-align: right;
      font-weight: 600;
      font-size: 16px;
    }
    
    .total-amount {
      font-size: 18px;
      color: #FF6B35;
      margin-top: 5px;
    }

    /* Secci√≥n de Patr√≥n */
    .pattern-container {
      width: 100%;
      height: 200px;
      position: relative;
      border: 2px solid #e1e5e9;
      border-radius: 10px;
      margin-top: 10px;
      background-color: white;
    }

    .pattern-container canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    .pattern-sequence {
      text-align: center;
      margin-top: 10px;
      font-family: monospace;
      color: #FF6B35;
    }

    /* Secci√≥n de Fotos */
    .photo-upload {
      border: 2px dashed #FF9800;
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
    }

    .photo-preview {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }

    .preview-image {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 8px;
    }

    .btn {
      background: linear-gradient(135deg, #FF6B35 0%, #FF9800 100%);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      margin-top: 20px;
      width: 100%;
    }

    @media (max-width: 768px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .services-section {
        grid-column: span 1;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üîß DR.XIAOMI</h1>
      <p>Sistema de Recibos de Servicio T√©cnico</p>
    </header>
    
    <main>
      <form id="receiptForm">
        <div class="form-grid">
          <!-- Datos del Cliente -->
          <div class="form-section">
            <h3>üë§ Datos del Cliente</h3>
            <div class="form-group">
              <label>Nombre completo</label>
              <input type="text" id="clientName" required placeholder="Ej: Juan P√©rez">
            </div>
            <div class="form-group">
              <label>Tel√©fono</label>
              <input type="tel" id="clientPhone" required placeholder="Ej: 75522004">
            </div>
          </div>

          <!-- Datos del Dispositivo -->
          <div class="form-section">
            <h3>üì± Dispositivo</h3>
            <div class="form-group">
              <label>Marca</label>
              <select id="deviceBrand" required>
                <option value="">Seleccionar marca</option>
                <option>Xiaomi</option>
                <option>Redmi</option>
                <option>POCO</option>
                <option>Otro</option>
              </select>
            </div>
            <div class="form-group">
              <label>Modelo</label>
              <input type="text" id="deviceModel" required placeholder="Ej: Redmi Note 10">
            </div>
            <div class="form-group">
              <label>IMEI/Serial</label>
              <input type="text" id="deviceImei" placeholder="15 d√≠gitos">
            </div>
            <div class="form-group">
              <label>¬øEnciende?</label>
              <select id="devicePower">
                <option value="si">S√≠</option>
                <option value="no">No</option>
              </select>
            </div>
          </div>

          <!-- Estado y Falla -->
          <div class="form-section">
            <h3>üîç Estado y Falla</h3>
            <div class="form-group">
              <label>Estado f√≠sico</label>
              <textarea id="deviceState" rows="3" placeholder="Describa el estado f√≠sico"></textarea>
            </div>
            <div class="form-group">
              <label>Falla reportada</label>
              <textarea id="reportedFault" rows="3" placeholder="Describa la falla"></textarea>
            </div>
          </div>

          <!-- Seguridad -->
          <div class="form-section">
            <h3>üîí Seguridad</h3>
            <div class="form-group">
              <label>Tipo</label>
              <select id="securityType">
                <option value="patron">Patr√≥n</option>
                <option value="pin">PIN</option>
                <option value="ninguno">Ninguno</option>
              </select>
            </div>
            <div id="pinContainer" style="display: none; margin-top: 10px;">
              <label>PIN</label>
              <input type="password" id="pinInput" maxlength="6" placeholder="6 d√≠gitos">
            </div>
            <div id="patternContainer">
              <div class="pattern-container">
                <canvas id="bgCanvas" width="300" height="200"></canvas>
                <canvas id="lineCanvas" width="300" height="200"></canvas>
              </div>
              <div class="pattern-sequence" id="patternSequence">Dibuje su patr√≥n</div>
            </div>
          </div>

          <!-- Fotos -->
          <div class="form-section">
            <h3>üì∏ Fotos del Equipo</h3>
            <div class="photo-upload" onclick="document.getElementById('photos').click()">
              <input type="file" id="photos" accept="image/*" multiple style="display: none;">
              <div>üì∑ Haz clic para seleccionar fotos</div>
              <small>M√°ximo 4 im√°genes</small>
            </div>
            <div id="photoPreview" class="photo-preview"></div>
          </div>

          <!-- Servicios Mejorados -->
          <div class="form-section services-section">
            <div class="services-header">
              <h3>üõ†Ô∏è Servicios y Costos</h3>
              <button type="button" class="add-service-btn" id="addServiceBtn">
                <span>+</span> A√±adir servicio
              </button>
            </div>
            
            <div class="services-list" id="servicesList">
              <!-- Los servicios se agregar√°n aqu√≠ din√°micamente -->
            </div>
            
            <div class="total-section">
              <div>Total a pagar</div>
              <div class="total-amount" id="totalAmount">Bs. 0.00</div>
            </div>
          </div>
        </div>

        <input type="hidden" id="patternValue">
        <button type="submit" class="btn">üìÑ Generar Recibo PDF</button>
      </form>
    </main>
  </div>

  <script>
    // Configuraci√≥n inicial
    let receiptCounter = 1340;
    const config = {
      storeName: "DR.XIAOMI",
      address: "Centro Comercial Ca√±oto #k1, Santa Cruz",
      phone: "75522004",
      schedule: "Lunes a Viernes 9:00 - 18:00"
    };

    document.addEventListener('DOMContentLoaded', function() {
      // Toggle seguridad
      const securityType = document.getElementById('securityType');
      const pinContainer = document.getElementById('pinContainer');
      const patternContainer = document.getElementById('patternContainer');
      
      securityType.addEventListener('change', function() {
        pinContainer.style.display = this.value === 'pin' ? 'block' : 'none';
        patternContainer.style.display = this.value === 'patron' ? 'block' : 'none';
      });

      // Vista previa de fotos
      document.getElementById('photos').addEventListener('change', function() {
        const preview = document.getElementById('photoPreview');
        preview.innerHTML = '';
        
        if (this.files.length > 4) {
          alert('M√°ximo 4 fotos permitidas');
          this.value = '';
          return;
        }
        
        Array.from(this.files).forEach(file => {
          const reader = new FileReader();
          reader.onload = function(e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.classList.add('preview-image');
            preview.appendChild(img);
          };
          reader.readAsDataURL(file);
        });
      });

      // Sistema de Patr√≥n
      class PatternLock {
        constructor() {
          this.bgCanvas = document.getElementById('bgCanvas');
          this.lineCanvas = document.getElementById('lineCanvas');
          this.bgCtx = this.bgCanvas.getContext('2d');
          this.lineCtx = this.lineCanvas.getContext('2d');
          this.radius = 15;
          this.points = [];
          this.path = [];
          this.isDrawing = false;
          this.init();
        }

        init() {
          this.createPoints();
          this.draw();
          this.attachEvents();
        }

        createPoints() {
          const cols = 3, rows = 3, margin = 30;
          const stepX = (this.bgCanvas.width - 2 * margin) / (cols - 1);
          const stepY = (this.bgCanvas.height - 2 * margin) / (rows - 1);
          
          let id = 1;
          for (let row = 0; row < rows; row++) {
            for (let col = 0; col < cols; col++) {
              this.points.push({
                id: id++,
                x: margin + stepX * col,
                y: margin + stepY * row,
                selected: false
              });
            }
          }
        }

        draw() {
          this.bgCtx.clearRect(0, 0, this.bgCanvas.width, this.bgCanvas.height);
          this.bgCtx.strokeStyle = '#FF9800';
          this.bgCtx.lineWidth = 2;
          
          this.points.forEach(point => {
            this.bgCtx.beginPath();
            this.bgCtx.arc(point.x, point.y, this.radius, 0, Math.PI * 2);
            this.bgCtx.stroke();
          });
        }

        attachEvents() {
          this.lineCanvas.addEventListener('mousedown', (e) => this.startDrawing(e));
          this.lineCanvas.addEventListener('mousemove', (e) => this.continueDrawing(e));
          this.lineCanvas.addEventListener('mouseup', () => this.stopDrawing());
        }

        getPosition(e) {
          const rect = this.lineCanvas.getBoundingClientRect();
          return {
            x: e.clientX - rect.left,
            y: e.clientY - rect.top
          };
        }

        findNearestPoint(pos) {
          return this.points.find(point => {
            if (point.selected) return false;
            const distance = Math.sqrt(
              Math.pow(point.x - pos.x, 2) + Math.pow(point.y - pos.y, 2)
            );
            return distance < this.radius + 10;
          });
        }

        startDrawing(e) {
          e.preventDefault();
          this.isDrawing = true;
          this.path = [];
          this.points.forEach(point => point.selected = false);
          this.lineCtx.clearRect(0, 0, this.lineCanvas.width, this.lineCanvas.height);
          document.getElementById('patternSequence').textContent = 'Dibujando...';
        }

        continueDrawing(e) {
          if (!this.isDrawing) return;
          e.preventDefault();
          
          const pos = this.getPosition(e);
          const nearestPoint = this.findNearestPoint(pos);
          
          if (nearestPoint) {
            nearestPoint.selected = true;
            this.path.push(nearestPoint);
          }
          
          this.renderPath(pos);
        }

        stopDrawing() {
          if (!this.isDrawing) return;
          this.isDrawing = false;
          
          const sequence = this.path.map(point => point.id);
          document.getElementById('patternSequence').textContent = `Patr√≥n: ${sequence.join(' ‚Üí ')}`;
          document.getElementById('patternValue').value = sequence.join(',');
        }

        renderPath(currentPos) {
          this.lineCtx.clearRect(0, 0, this.lineCanvas.width, this.lineCanvas.height);
          if (!this.path.length) return;
          
          this.lineCtx.strokeStyle = '#FF6B35';
          this.lineCtx.lineWidth = 3;
          this.lineCtx.lineCap = 'round';
          this.lineCtx.beginPath();
          this.lineCtx.moveTo(this.path[0].x, this.path[0].y);
          
          for (let i = 1; i < this.path.length; i++) {
            this.lineCtx.lineTo(this.path[i].x, this.path[i].y);
          }
          
          if (this.isDrawing) {
            this.lineCtx.lineTo(currentPos.x, currentPos.y);
          }
          
          this.lineCtx.stroke();
          
          // Dibujar puntos seleccionados
          this.path.forEach(point => {
            this.lineCtx.beginPath();
            this.lineCtx.arc(point.x, point.y, this.radius / 2, 0, Math.PI * 2);
            this.lineCtx.fillStyle = '#FF6B35';
            this.lineCtx.fill();
          });
        }
      }

      const lock = new PatternLock();

      // Sistema de Servicios Din√°micos
      const servicesList = document.getElementById('servicesList');
      const addServiceBtn = document.getElementById('addServiceBtn');
      const totalAmount = document.getElementById('totalAmount');
      
      function addService(description = '', price = '') {
        const serviceId = Date.now();
        const serviceRow = document.createElement('div');
        serviceRow.className = 'service-row';
        serviceRow.dataset.id = serviceId;
        
        serviceRow.innerHTML = `
          <input type="text" placeholder="Descripci√≥n del servicio" value="${description}" class="service-desc">
          <input type="number" placeholder="Bs. 0.00" min="0" step="0.01" value="${price}" class="service-price">
          <button type="button" class="remove-service-btn">√ó</button>
        `;
        
        servicesList.appendChild(serviceRow);
        
        // Evento para eliminar servicio
        serviceRow.querySelector('.remove-service-btn').addEventListener('click', function() {
          serviceRow.remove();
          calculateTotal();
        });
        
        // Eventos para calcular total
        serviceRow.querySelector('.service-desc').addEventListener('input', calculateTotal);
        serviceRow.querySelector('.service-price').addEventListener('input', calculateTotal);
      }
      
      function calculateTotal() {
        let total = 0;
        const priceInputs = document.querySelectorAll('.service-price');
        
        priceInputs.forEach(input => {
          const value = parseFloat(input.value) || 0;
          total += value;
        });
        
        totalAmount.textContent = `Bs. ${total.toFixed(2)}`;
      }
      
      // Evento para a√±adir nuevo servicio
      addServiceBtn.addEventListener('click', function() {
        addService();
      });
      
      // A√±adir un servicio inicial
      addService();

      // Generar PDF Profesional
      document.getElementById('receiptForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const { jsPDF } = window.jsPDF;
        const pdf = new jsPDF();
        
        // Configuraci√≥n inicial
        pdf.setProperties({
          title: `Recibo de Servicio T√©cnico REC-${receiptCounter}`,
          subject: 'Recibo de servicio t√©cnico',
          author: config.storeName
        });
        
        // Fondo con borde naranja
        pdf.setDrawColor(255, 107, 53);
        pdf.setLineWidth(1);
        pdf.rect(5, 5, 200, 287);
        
        // Encabezado
        pdf.setFontSize(18);
        pdf.setTextColor(255, 107, 53);
        pdf.setFont('helvetica', 'bold');
        pdf.text(config.storeName, 105, 20, { align: 'center' });
        
        // Informaci√≥n de contacto
        pdf.setFontSize(10);
        pdf.setTextColor(100, 100, 100);
        pdf.setFont('helvetica', 'normal');
        pdf.text(config.address, 105, 27, { align: 'center' });
        pdf.text(`Tel: ${config.phone} | ${config.schedule}`, 105, 32, { align: 'center' });
        
        // L√≠nea divisoria
        pdf.setDrawColor(255, 107, 53);
        pdf.setLineWidth(0.5);
        pdf.line(15, 38, 195, 38);
        
        // T√≠tulo del recibo
        pdf.setFontSize(14);
        pdf.setTextColor(40, 40, 40);
        pdf.setFont('helvetica', 'bold');
        pdf.text('RECIBO DE SERVICIO T√âCNICO', 105, 45, { align: 'center' });
        
        // N√∫mero de recibo y fecha
        const now = new Date();
        const formattedDate = now.toLocaleDateString('es-ES', {
          day: '2-digit',
          month: 'long',
          year: 'numeric'
        });
        const formattedTime = now.toLocaleTimeString('es-ES', {
          hour: '2-digit',
          minute: '2-digit'
        });
        
        pdf.setFontSize(10);
        pdf.text(`N¬∫ Recibo: REC-${receiptCounter}`, 20, 55);
        pdf.text(`Fecha: ${formattedDate} - ${formattedTime}`, 160, 55, { align: 'right' });
        
        // L√≠nea divisoria
        pdf.line(15, 60, 195, 60);
        
        // Datos del cliente
        pdf.setFontSize(12);
        pdf.setTextColor(40, 40, 40);
        pdf.setFont('helvetica', 'bold');
        pdf.text('DATOS DEL CLIENTE', 20, 70);
        
        pdf.setFont('helvetica', 'normal');
        pdf.text(`Nombre: ${document.getElementById('clientName').value}`, 25, 77);
        pdf.text(`Tel√©fono: ${document.getElementById('clientPhone').value}`, 25, 84);
        
        // Datos del dispositivo
        pdf.setFont('helvetica', 'bold');
        pdf.text('DATOS DEL DISPOSITIVO', 20, 94);
        
        pdf.setFont('helvetica', 'normal');
        pdf.text(`Marca: ${document.getElementById('deviceBrand').value}`, 25, 101);
        pdf.text(`Modelo: ${document.getElementById('deviceModel').value}`, 25, 108);
        pdf.text(`Enciende: ${document.getElementById('devicePower').value === 'si' ? 'S√≠' : 'No'}`, 25, 115);
        if(document.getElementById('deviceImei').value) {
          pdf.text(`IMEI/Serial: ${document.getElementById('deviceImei').value}`, 25, 122);
        }
        
        // Estado y falla
        pdf.setFont('helvetica', 'bold');
        pdf.text('ESTADO Y FALLA REPORTADA', 20, 132);
        
        pdf.setFont('helvetica', 'normal');
        const deviceState = document.getElementById('deviceState').value || 'No especificado';
        const reportedFault = document.getElementById('reportedFault').value || 'No especificado';
        pdf.text(`Estado: ${deviceState}`, 25, 139);
        pdf.text(`Falla: ${reportedFault}`, 25, 146);
        
        // Seguridad
        const securityType = document.getElementById('securityType').value;
        pdf.setFont('helvetica', 'bold');
        pdf.text('SEGURIDAD', 20, 156);
        
        pdf.setFont('helvetica', 'normal');
        if (securityType === 'patron') {
          // Capturar patr√≥n como imagen
          const bg = document.getElementById('bgCanvas');
          const ln = document.getElementById('lineCanvas');
          const tempCanvas = document.createElement('canvas');
          tempCanvas.width = bg.width;
          tempCanvas.height = bg.height;
          const ctx = tempCanvas.getContext('2d');
          ctx.drawImage(bg, 0, 0);
          ctx.drawImage(ln, 0, 0);
          
          pdf.addImage(tempCanvas.toDataURL(), 'PNG', 25, 161, 30, 20);
          pdf.text(`Patr√≥n: ${document.getElementById('patternValue').value.split(',').join(' ‚Üí ')}`, 60, 171);
        } else if (securityType === 'pin') {
          pdf.text(`PIN: ${document.getElementById('pinInput').value}`, 25, 161);
        } else {
          pdf.text('Ninguno', 25, 161);
        }
        
        // Servicios - Tabla profesional
        pdf.setFont('helvetica', 'bold');
        pdf.text('DETALLE DE SERVICIOS', 20, 185);
        
        const serviceRows = document.querySelectorAll('.service-row');
        const servicesData = [];
        let total = 0;
        
        serviceRows.forEach(row => {
          const desc = row.querySelector('.service-desc').value;
          const price = parseFloat(row.querySelector('.service-price').value) || 0;
          
          if (desc && price > 0) {
            servicesData.push({
              descripci√≥n: desc,
              precio: `Bs. ${price.toFixed(2)}`
            });
            total += price;
          }
        });
        
        if (servicesData.length > 0) {
          pdf.autoTable({
            startY: 190,
            head: [['Descripci√≥n', 'Precio']],
            body: servicesData.map(item => [item.descripci√≥n, item.precio]),
            headStyles: {
              fillColor: [255, 107, 53],
              textColor: [255, 255, 255],
              fontStyle: 'bold',
              halign: 'center'
            },
            columnStyles: {
              0: { cellWidth: 'auto', fontStyle: 'bold' },
              1: { halign: 'right' }
            },
            margin: { left: 20, right: 20 },
            styles: {
              cellPadding: 5,
              fontSize: 10,
              valign: 'middle'
            },
            theme: 'grid'
          });
        } else {
          pdf.setFont('helvetica', 'italic');
          pdf.setTextColor(150, 150, 150);
          pdf.text('No se registraron servicios', 25, 190);
        }
        
        // Total
        if (total > 0) {
          const finalY = pdf.autoTable.previous?.finalY || 190;
          
          pdf.setFont('helvetica', 'bold');
          pdf.setTextColor(255, 107, 53);
          pdf.text(`TOTAL A PAGAR: Bs. ${total.toFixed(2)}`, 160, finalY + 15, { align: 'right' });
          
          // L√≠nea divisoria final
          pdf.setDrawColor(255, 107, 53);
          pdf.line(15, finalY + 20, 195, finalY + 20);
        }
        
        // T√©rminos y condiciones
        pdf.setFontSize(8);
        pdf.setTextColor(100, 100, 100);
        const finalY = pdf.autoTable.previous?.finalY || 190;
        pdf.text('El cliente acepta que el equipo ser√° revisado y diagnosticado', 105, finalY + 30, { align: 'center' });
        pdf.text('No nos hacemos responsables por datos perdidos durante el servicio t√©cnico', 105, finalY + 35, { align: 'center' });
        pdf.text('Equipos no reclamados en 30 d√≠as ser√°n dados de baja', 105, finalY + 40, { align: 'center' });
        
        // Guardar PDF
        pdf.save(`REC-${receiptCounter++}.pdf`);
      });
    });
  </script>
</body>
</html>
