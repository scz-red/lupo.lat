<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Art Projector Web</title>
  <style>
    body{font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:0; background:#0b0b0f; color:#fff;}
    header{padding:12px 14px; display:flex; gap:10px; align-items:center; flex-wrap:wrap; background:#12121a; position:sticky; top:0; z-index:10;}
    .btn{background:#2a2a3a; color:#fff; border:1px solid #3a3a55; padding:8px 10px; border-radius:10px; cursor:pointer;}
    .btn:active{transform:scale(.98)}
    label{display:flex; gap:8px; align-items:center; font-size:14px;}
    input[type="range"]{width:160px}
    main{display:grid; gap:12px; padding:12px; max-width:980px; margin:0 auto;}
    .stage{
      position:relative; width:100%;
      aspect-ratio: 9/16;
      background:#000; border-radius:14px; overflow:hidden;
      border:1px solid #2a2a3a;
      touch-action:none;
    }
    video, canvas{
      position:absolute; inset:0; width:100%; height:100%;
      object-fit:cover;
    }
    canvas{pointer-events:auto;}
    .hint{font-size:13px; opacity:.8}
  </style>
</head>
<body>
  <header>
    <button class="btn" id="startCam">üì∑ Iniciar c√°mara</button>
    <button class="btn" id="switchCam">üîÅ Cambiar</button>

    <label class="btn" style="padding:6px 10px;">
      üñºÔ∏è Elegir foto
      <input id="file" type="file" accept="image/*" hidden>
    </label>

    <label>Opacidad
      <input id="opacity" type="range" min="0" max="100" value="45">
      <span id="opv">45%</span>
    </label>

    <label>Zoom
      <input id="zoom" type="range" min="50" max="300" value="100">
      <span id="zv">100%</span>
    </label>

    <label><input id="mirror" type="checkbox"> Espejo</label>
    <button class="btn" id="center">üéØ Centrar</button>
    <button class="btn" id="clear">üßΩ Quitar foto</button>
  </header>

  <main>
    <div class="stage" id="stage">
      <video id="video" autoplay playsinline muted></video>
      <canvas id="overlay"></canvas>
    </div>

    <div class="hint">
      Arrastra para mover. En celular: 2 dedos para hacer zoom (pinch).
    </div>
  </main>

<script>
(() => {
  const video = document.getElementById('video');
  const canvas = document.getElementById('overlay');
  const ctx = canvas.getContext('2d');

  const file = document.getElementById('file');
  const opacity = document.getElementById('opacity');
  const opv = document.getElementById('opv');
  const zoom = document.getElementById('zoom');
  const zv = document.getElementById('zv');
  const mirror = document.getElementById('mirror');

  const startCamBtn = document.getElementById('startCam');
  const switchCamBtn = document.getElementById('switchCam');
  const centerBtn = document.getElementById('center');
  const clearBtn = document.getElementById('clear');
  const stage = document.getElementById('stage');

  let stream = null;
  let facingMode = 'environment'; // 'user' o 'environment'

  const img = new Image();
  let hasImage = false;
  let imgX = 0, imgY = 0;
  let imgScale = 1;

  function resizeCanvas() {
    const r = stage.getBoundingClientRect();
    canvas.width = Math.round(r.width * devicePixelRatio);
    canvas.height = Math.round(r.height * devicePixelRatio);
    canvas.style.width = r.width + 'px';
    canvas.style.height = r.height + 'px';
    draw();
  }
  window.addEventListener('resize', resizeCanvas);

  function draw() {
    ctx.setTransform(1,0,0,1,0,0);
    ctx.clearRect(0,0,canvas.width,canvas.height);
    if (!hasImage) return;

    ctx.globalAlpha = Number(opacity.value) / 100;

    const w = canvas.width, h = canvas.height;

    ctx.save();
    if (mirror.checked) {
      ctx.translate(w, 0);
      ctx.scale(-1, 1);
    }

    const baseScale = (Number(zoom.value) / 100);
    const scale = imgScale * baseScale;

    const iw = img.naturalWidth * scale;
    const ih = img.naturalHeight * scale;

    const cx = w/2 + imgX;
    const cy = h/2 + imgY;

    ctx.drawImage(img, cx - iw/2, cy - ih/2, iw, ih);
    ctx.restore();

    ctx.globalAlpha = 1;
  }

  opacity.addEventListener('input', () => { opv.textContent = opacity.value + '%'; draw(); });
  zoom.addEventListener('input', () => { zv.textContent = zoom.value + '%'; draw(); });
  mirror.addEventListener('change', () => {
    video.style.transform = mirror.checked ? 'scaleX(-1)' : 'none';
    draw();
  });

  file.addEventListener('change', async (e) => {
    const f = e.target.files?.[0];
    if (!f) return;
    const url = URL.createObjectURL(f);
    img.onload = () => {
      hasImage = true;
      imgX = 0; imgY = 0; imgScale = 1;
      draw();
      URL.revokeObjectURL(url);
    };
    img.src = url;
  });

  clearBtn.addEventListener('click', () => {
    hasImage = false;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    file.value = '';
  });

  centerBtn.addEventListener('click', () => { imgX = 0; imgY = 0; imgScale = 1; draw(); });

  async function startCamera() {
    if (stream) {
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }
    try {
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode },
        audio: false
      });
      video.srcObject = stream;
    } catch (err) {
      alert('No se pudo abrir la c√°mara. Aseg√∫rate de estar en HTTPS y dar permisos.\n\n' + err);
    }
  }

  startCamBtn.addEventListener('click', startCamera);
  switchCamBtn.addEventListener('click', async () => {
    facingMode = (facingMode === 'environment') ? 'user' : 'environment';
    await startCamera();
  });

  // Drag + pinch
  let pointers = new Map();
  let last = null;
  let lastDist = null;

  function getPoint(e) {
    const rect = canvas.getBoundingClientRect();
    const x = (e.clientX - rect.left) * devicePixelRatio;
    const y = (e.clientY - rect.top) * devicePixelRatio;
    return {x,y};
  }

  canvas.addEventListener('pointerdown', (e) => {
    canvas.setPointerCapture(e.pointerId);
    pointers.set(e.pointerId, getPoint(e));
    last = null;
    lastDist = null;
  });

  canvas.addEventListener('pointermove', (e) => {
    if (!hasImage) return;
    if (!pointers.has(e.pointerId)) return;
    pointers.set(e.pointerId, getPoint(e));

    const pts = [...pointers.values()];
    if (pts.length === 1) {
      const p = pts[0];
      if (last) {
        imgX += (p.x - last.x);
        imgY += (p.y - last.y);
        draw();
      }
      last = p;
    } else if (pts.length >= 2) {
      const [a,b] = pts;
      const dist = Math.hypot(a.x - b.x, a.y - b.y);
      if (lastDist) {
        const factor = dist / lastDist;
        imgScale *= factor;
        imgScale = Math.max(0.1, Math.min(10, imgScale));
        draw();
      }
      lastDist = dist;
      last = null;
    }
  });

  function endPointer(e) {
    pointers.delete(e.pointerId);
    last = null;
    lastDist = null;
  }
  canvas.addEventListener('pointerup', endPointer);
  canvas.addEventListener('pointercancel', endPointer);

  resizeCanvas();
})();
</script>
</body>
</html>
