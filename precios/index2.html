<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Buscador de Precios</title>
  <style>
    :root{
      --bg:#0e0e11; --bg2:#14141a; --border:#2a2a33; --text:#e5e5e5;
      --muted:#a1a1aa; --accent:#ffa047;
    }
    body { background:var(--bg); color:var(--text); font-family:Inter,system-ui,Segoe UI,Roboto,Arial; margin:0; }
    .wrap { max-width:1200px; margin:auto; padding:16px; }
    header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
    h1 { font-size:18px; color:var(--accent); margin:0; }
    .toolbar { display:flex; flex-wrap:wrap; gap:10px; margin-bottom:10px; }
    .toolbar input[type=text] { flex:1; padding:10px; border-radius:10px; border:1px solid var(--border); background:#15151b; color:#fff; }
    .toolbar label { display:flex; align-items:center; gap:6px; color:var(--muted); font-size:13px; }
    .card { background:var(--bg2); border:1px solid var(--border); border-radius:14px; overflow:auto; }
    table { width:100%; border-collapse:collapse; table-layout:fixed; }
    th,td { padding:10px; border-bottom:1px solid #222; text-align:left; font-size:13px; word-wrap:break-word; }
    th { background:#1a1a20; position:sticky; top:0; z-index:5; }
    tr:hover { background:#18181d; }
    .btn { background:var(--accent); color:#000; border:none; border-radius:10px; padding:6px 10px; cursor:pointer; font-weight:600; font-size:12px; }
    input.editable { background:#111; border:1px dashed #333; color:#fff; padding:5px; border-radius:6px; width:90px; }

    /* Anchos pensados para que quepa todo en m√≥vil */
    thead th:nth-child(1), tbody td:nth-child(1){width:18%}  /* Marca */
    thead th:nth-child(2), tbody td:nth-child(2){width:24%}  /* Modelo */
    thead th:nth-child(3), tbody td:nth-child(3){width:10%}  /* Tipo   */
    thead th:nth-child(4), tbody td:nth-child(4){width:16%}  /* Prov.  */
    thead th:nth-child(5), tbody td:nth-child(5){width:14%}  /* Compra */
    thead th:nth-child(6), tbody td:nth-child(6){width:12%}  /* Venta  */
    thead th:nth-child(7), tbody td:nth-child(7){width:6%}   /* Acc.   */

    /* Ocultar Proveedor (4) y Compra (5) cuando NO se muestran proveedores */
    .table-container.hide-provider thead th:nth-child(4),
    .table-container.hide-provider tbody td:nth-child(4),
    .table-container.hide-provider thead th:nth-child(5),
    .table-container.hide-provider tbody td:nth-child(5){
      display:none;
    }
    /* Ocultar la tabla completa cuando estamos en modo inicio (sin b√∫squeda) */
    .table-container.hidden { display:none; }

    /* Panel de inicio con YouTube */
    .home-panel { border:1px solid var(--border); border-radius:12px; background:#121218; padding:14px; margin:10px 0 12px; }
    .home-hero h2 { color:var(--accent); margin:0 0 6px; font-size:16px; }
    .home-sub { color:var(--muted); margin:0 0 10px; font-size:.9rem; }
    .video-wrap { position:relative; width:100%; aspect-ratio:16/9; border-radius:10px; overflow:hidden; }
    .video-wrap iframe { position:absolute; inset:0; width:100%; height:100%; }
    .home-tip { display:block; color:var(--muted); margin-top:8px; font-size:.85rem; }

    @media (max-width:480px){
      th,td{padding:6px; font-size:11px}
      input.editable{font-size:11px; width:70px}
      .toolbar input[type=text]{padding:9px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Buscador de Precios</h1>
    </header>

    <div class="toolbar" role="search" aria-label="Buscador">
      <input id="searchInput" type="text" placeholder="Buscar por marca, modelo, tipo..." aria-label="Buscar" />
      <label><input type="checkbox" id="showProvidersToggle"> Mostrar proveedores (precios de compra)</label>
    </div>

    <!-- Panel de inicio con YouTube (visible cuando no hay b√∫squeda) -->
    <div id="homePanel" class="home-panel">
      <div class="home-hero">
        <h2>üé• Servicio t√©cnico ‚Äî videos</h2>
        <p class="home-sub">Tips, cambios de pantallas y diagn√≥sticos r√°pidos. Empieza a escribir arriba para buscar precios.</p>
       <!-- üé• Videos aleatorios de servicio t√©cnico -->
<div class="video-wrap">
  <iframe id="ytFrame" frameborder="0" allowfullscreen
    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
    loading="lazy"></iframe>
</div>

<script>
  // üéûÔ∏è Lista de videos de YouTube (solo los IDs, no las URLs completas)
  const videos = [
    "41IIFUWPwug", // Ejemplo: cambio de pantalla
    "GR8TLPJxihk", // Ejemplo: cambio de bater√≠a
    "zHj43FDLdTk", // Ejemplo: reparaci√≥n de carga
    "jyrbTnFhA0A", // Ejemplo: limpieza de placa
    "3Fc23G1O-BA"  // Ejemplo: tips de diagn√≥stico
  ];

  // üîÄ Elegir uno al azar y cargarlo
  const randomId = videos[Math.floor(Math.random() * videos.length)];
  const videoUrl = `https://www.youtube.com/embed/${randomId}?autoplay=1&mute=1&rel=0&playsinline=1&loop=1&playlist=${randomId}`;
  document.getElementById("ytFrame").src = videoUrl;
</script>

        <small class="home-tip">La tabla aparecer√° autom√°ticamente cuando empieces a escribir.</small>
      </div>
    </div>

    <div class="card table-container hidden" id="tableWrap">
      <table id="priceTable">
        <thead>
          <tr>
            <th>Marca</th>
            <th>Modelo</th>
            <th>Tipo</th>
            <th>Prov.</th>
            <th>Compra</th>
            <th>Venta</th>
            <th>Acc.</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <script>
    // ===== Configura aqu√≠ tus listas CSV =====
    const CONFIG = [
      { nombre:'J&A', archivo:'data/ja.csv' },
      { nombre:'CentralCel', archivo:'data/centralcel.csv' },
      { nombre:'OSMobil', archivo:'data/osmobil.csv' }
      // Agrega m√°s si quieres
    ];
    const EDIT_PASSWORD = '2025';

    // ===== Estado =====
    let allRows = [], view = [];
    let editUnlocked = false;
    let searchTerm = '';
    let searchTimer = null;

    // ===== DOM =====
    const q = document.getElementById('searchInput');
    const tbody = document.getElementById('tbody');
    const tableWrap = document.getElementById('tableWrap');
    const homePanel = document.getElementById('homePanel');
    const toggle = document.getElementById('showProvidersToggle');

    // ===== Utils =====
    const slug = s => (s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    const toNum = v => {
      if (v === null || v === undefined || v === '') return '';
      const n = Number(String(v).replace(/[^0-9.,-]/g,'').replace(',','.'));
      return Number.isFinite(n) ? n : '';
    };
    const fmt = v => (v === '' ? '' : Number(v).toFixed(2));

    function parseCSV(text){
      // Soporta comillas y comas internas
      const lines = text.replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n').filter(l=>l.trim()!=='');
      const parseLine = (line) => {
        const out=[]; let cur='', inQ=false;
        for (let i=0;i<line.length;i++){
          const ch=line[i];
          if (ch === '"'){ inQ = !inQ; continue; }
          if (ch === ',' && !inQ){ out.push(cur); cur=''; continue; }
          cur += ch;
        }
        out.push(cur);
        return out.map(s=>s.trim());
      };
      const head = parseLine(lines[0]).map(h=>slug(h));
      return lines.slice(1).map(l=>{
        const c = parseLine(l); const o={}; head.forEach((h,i)=>o[h]=c[i]??''); return o;
      });
    }

    function coerce(o, listaNombre){
      return {
        lista: listaNombre,
        marca: o.marca || '',
        modelo: o.modelo || '',
        tipo: (o.tipo||'').toUpperCase(),
        proveedor: o.proveedor || '',
        precio_compra: toNum(o.precio_compra),
        precio_venta: toNum(o.precio_venta)
      };
    }

    async function loadData(){
      const all=[];
      for (const l of CONFIG){
        try{
          const r = await fetch(l.archivo, { cache:'no-store' });
          if(!r.ok) { console.warn('No se pudo cargar', l.archivo); continue; }
          const t = await r.text();
          const parsed = parseCSV(t).map(o=>coerce(o,l.nombre));
          all.push(...parsed);
        }catch(e){ console.warn('Error cargando', l.archivo, e); }
      }
      allRows = all;
      applyFilters(); // respetar√° el estado "inicio" (sin b√∫squeda)
    }

    function applyFilters(){
      const hasSearch = (searchTerm || '').trim().length > 0;

      // Sin b√∫squeda ‚Üí panel de inicio con video, tabla oculta
      if (!hasSearch){
        homePanel.style.display = 'block';
        tableWrap.classList.add('hidden');
        tbody.innerHTML = ''; // aseg√∫rate de limpiar la tabla
        return;
      }

      // Con b√∫squeda ‚Üí mostrar tabla y ocultar panel
      homePanel.style.display = 'none';
      tableWrap.classList.remove('hidden');

      // Filtrado
      const s = slug(searchTerm);
      let base = allRows.filter(r =>
        slug(`${r.lista} ${r.marca} ${r.modelo} ${r.tipo} ${r.proveedor} ${r.precio_compra} ${r.precio_venta}`).includes(s)
      );

      // Mejor precio si el toggle est√° apagado
      if (!toggle.checked){
        const best = new Map();
        for (const r of base){
          const key = `${r.marca}|${r.modelo}|${r.tipo}`;
          const curr = best.get(key);
          const rc = (r.precio_compra === '' ? Infinity : r.precio_compra);
          const cc = (curr?.precio_compra === '' ? Infinity : curr?.precio_compra);
          if (!curr || rc < cc) best.set(key, r);
        }
        view = [...best.values()];
      } else {
        view = base;
      }

      render();
    }

    function render(){
      tbody.innerHTML = view.map(r=>{
        const id = `${r.marca}|${r.modelo}|${r.tipo}|${r.proveedor}|${r.precio_compra}`;
        const ventaVal = r.precio_venta === '' ? '' : fmt(r.precio_venta);
        const compraVal = r.precio_compra === '' ? '' : fmt(r.precio_compra);
        return `<tr>
          <td>${r.marca}</td>
          <td>${r.modelo}</td>
          <td>${r.tipo}</td>
          <td>${r.proveedor}</td>
          <td>${compraVal}</td>
          <td><input class="editable" data-id="${id}" value="${ventaVal}" placeholder="0.00" disabled></td>
          <td><button class="btn" onclick="editRow('${id}')">Editar</button></td>
        </tr>`;
      }).join('');
    }

    function editRow(id){
      if(!editUnlocked){
        const pass = prompt('Ingrese la clave de edici√≥n:');
        if (pass === EDIT_PASSWORD){ editUnlocked = true; } else { alert('Clave incorrecta'); return; }
      }
      const inp = document.querySelector(`input.editable[data-id="${id}"]`);
      if (inp){ inp.disabled = false; inp.focus(); }
    }

    // ===== Eventos =====
    // B√∫squeda con debounce (suave en m√≥viles)
    q.addEventListener('input', (e)=>{
      searchTerm = e.target.value;
      clearTimeout(searchTimer);
      searchTimer = setTimeout(applyFilters, 160);
    });

    // Toggle: oculta columnas prov+compra cuando est√° apagado
    toggle.addEventListener('change', (e)=>{
      tableWrap.classList.toggle('hide-provider', !e.target.checked);
      applyFilters();
    });

    // Estado inicial: sin b√∫squeda
    (function init(){
      q.value = '';
      searchTerm = '';
      tableWrap.classList.add('hidden');
      homePanel.style.display = 'block';
      // Si al cargar ya quieres ocultar prov/compra porque est√° apagado:
      tableWrap.classList.toggle('hide-provider', !toggle.checked);
      loadData();
    })();
  </script>
</body>
</html>
