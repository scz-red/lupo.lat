// -------------------------
// POPUP CON API DE MODELOS
// -------------------------

function showPhoneInfoModal() {
    document.getElementById('phoneInfoModal').style.display = 'flex';
}

function hidePhoneInfoModal() {
    document.getElementById('phoneInfoModal').style.display = 'none';
    document.getElementById('phoneInfoBody').innerHTML = '';
}

/**
 * Abre el popup y busca info del modelo usando la API:
 * https://api-mobilespecs.azharimm.dev
 */
async function openPhoneInfo(marcaEnc, modeloEnc) {
    const marca = decodeURIComponent(marcaEnc);
    const modelo = decodeURIComponent(modeloEnc);
    const phoneInfoBody = document.getElementById('phoneInfoBody');

    showPhoneInfoModal();
    phoneInfoBody.innerHTML = `<p>Buscando <strong>${marca} ${modelo}</strong>...</p>`;

    try {
        const query = encodeURIComponent(`${marca} ${modelo}`);
        const searchRes = await fetch(`https://api-mobilespecs.azharimm.dev/search?query=${query}`);
        const searchData = await searchRes.json();

        const phones = (searchData.data && searchData.data.phones) || [];
        if (!phones.length) {
            phoneInfoBody.innerHTML = `
                <p>No se encontró información para <strong>${marca} ${modelo}</strong>.</p>
                <p style="font-size:11px;">Prueba escribir el modelo más exacto en el CSV (por ejemplo: "Redmi Note 12 4G").</p>
            `;
            return;
        }

        // Tomamos el primer resultado
        const phone = phones[0];

        // Segundo fetch para detalles completos
        const detailRes = await fetch(`https://api-mobilespecs.azharimm.dev/${phone.slug}`);
        const detailData = await detailRes.json();
        const info = detailData.data || {};

        const img = info.thumbnail || phone.image;
        const name = info.phone_name || phone.phone_name || `${marca} ${modelo}`;
        const brand = info.brand || marca;
        const release = info.release_date || '';
        const os = info.os || '';
        const storage = info.storage || '';
        const dimension = info.dimension || info.dimensions || '';

        phoneInfoBody.innerHTML = `
            <div style="text-align:center; margin-bottom:10px;">
                ${img ? `<img src="${img}" alt="${name}" style="max-width:140px; border-radius:10px; margin-bottom:8px;">` : ''}
                <div style="font-size:13px; color:#fff;"><strong>${name}</strong></div>
                <div style="font-size:11px;">${brand}</div>
            </div>
            <div style="border-top:1px solid var(--border); padding-top:8px; font-size:11px;">
                ${release ? `<p><strong>Lanzamiento:</strong> ${release}</p>` : ''}
                ${os ? `<p><strong>SO:</strong> ${os}</p>` : ''}
                ${storage ? `<p><strong>Almacenamiento:</strong> ${storage}</p>` : ''}
                ${dimension ? `<p><strong>Dimensiones:</strong> ${dimension}</p>` : ''}
            </div>
        `;
    } catch (err) {
        console.error(err);
        phoneInfoBody.innerHTML = `
            <p>⚠️ No se pudo obtener la información del modelo.</p>
            <p style="font-size:11px;">Revisa tu conexión o intenta más tarde.</p>
        `;
    }
}
